# Celery é‚®ä»¶æœåŠ¡é›†æˆæ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

é‚®ä»¶è½®è¯¢åŠŸèƒ½å·²ä» **APScheduler** è¿ç§»åˆ° **Celery**ï¼Œå®ç°æ›´å¼ºå¤§çš„ä»»åŠ¡è°ƒåº¦å’Œåˆ†å¸ƒå¼å¤„ç†èƒ½åŠ›ã€‚

### å˜æ›´å†…å®¹

| åŠŸèƒ½ | æ—§å®ç° (APScheduler) | æ–°å®ç° (Celery) |
|------|---------------------|-----------------|
| **ä»»åŠ¡è°ƒåº¦** | APScheduler | Celery Beat |
| **ä»»åŠ¡æ‰§è¡Œ** | åå°çº¿ç¨‹ | Celery Worker |
| **çŠ¶æ€å­˜å‚¨** | å†…å­˜ | Redis |
| **ç®¡ç†æ–¹å¼** | Worker Manager | Celery CLI + Worker Manager |
| **ç›‘æ§é¢æ¿** | æ—  | Flower |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯åŠ¨ Celery æœåŠ¡

æœ‰ä¸¤ç§æ–¹å¼å¯åŠ¨ Celery æœåŠ¡ï¼š

#### æ–¹å¼ Aï¼šä½¿ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬ Celeryï¼‰
./scripts/start.sh

# æˆ–å•ç‹¬å¯åŠ¨ Celery
./scripts/celery.sh start
```

#### æ–¹å¼ Bï¼šæ‰‹åŠ¨å¯åŠ¨

```bash
cd backend
source venv/bin/activate

# ç»ˆç«¯ 1 - Celery Beatï¼ˆå®šæ—¶è°ƒåº¦å™¨ï¼‰
celery -A app.celery_app beat --loglevel=info

# ç»ˆç«¯ 2 - Celery Workerï¼ˆä»»åŠ¡æ‰§è¡Œå™¨ï¼‰
celery -A app.celery_app worker --loglevel=info --concurrency=10 -Q email

# ç»ˆç«¯ 3 - Flowerï¼ˆç›‘æ§é¢æ¿ï¼Œå¯é€‰ï¼‰
celery -A app.celery_app flower --port=5555
```

### 2. åŒæ­¥é‚®ä»¶è½®è¯¢ä»»åŠ¡

Celery å¯åŠ¨åï¼Œéœ€è¦åŒæ­¥é‚®ç®±è´¦æˆ·çš„è½®è¯¢ä»»åŠ¡ï¼š

```bash
cd backend
source venv/bin/activate
python sync_email_tasks.py
```

### 3. åœ¨ç®¡ç†åå°å¯åŠ¨/åœæ­¢é‚®ä»¶ Worker

è®¿é—®ç®¡ç†åå°çš„ Workers é¡µé¢ï¼š
```
http://localhost:3000/admin/workers
```

- **æ·»åŠ  Worker**ï¼šç‚¹å‡»"æ·»åŠ  Worker"ï¼Œé€‰æ‹©ç±»å‹ä¸º"é‚®ä»¶æœåŠ¡ (Celery)"
- **å¯åŠ¨**ï¼šç‚¹å‡»"å¯åŠ¨"æŒ‰é’®ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¯åŠ¨ Celery æœåŠ¡å¹¶åŒæ­¥é‚®ä»¶ä»»åŠ¡
- **åœæ­¢**ï¼šç‚¹å‡»"åœæ­¢"æŒ‰é’®ï¼Œç³»ç»Ÿä¼šåœæ­¢ Celery æœåŠ¡

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ celery_app.py                    # Celery åº”ç”¨é…ç½®
â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â””â”€â”€ email.py                     # é‚®ä»¶è½®è¯¢ä»»åŠ¡
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ email_worker_service.py      # Celery Beat ä»»åŠ¡ç®¡ç†
â”‚   â””â”€â”€ workers/
â”‚       â””â”€â”€ email_worker.py              # Worker Manager é€‚é…å™¨
â”œâ”€â”€ sync_email_tasks.py                  # é‚®ä»¶ä»»åŠ¡åŒæ­¥è„šæœ¬
â””â”€â”€ venv/

scripts/
â”œâ”€â”€ celery.sh                            # Celery ç®¡ç†è„šæœ¬
â”œâ”€â”€ start.sh                             # å¯åŠ¨è„šæœ¬ï¼ˆå·²é›†æˆ Celeryï¼‰
â”œâ”€â”€ stop.sh                              # åœæ­¢è„šæœ¬ï¼ˆå·²é›†æˆ Celeryï¼‰
â””â”€â”€ restart.sh                           # é‡å¯è„šæœ¬ï¼ˆå·²é›†æˆ Celeryï¼‰

logs/
â”œâ”€â”€ celery-beat.log                      # Celery Beat æ—¥å¿—
â”œâ”€â”€ celery-worker.log                    # Celery Worker æ—¥å¿—
â””â”€â”€ celery-flower.log                    # Flower æ—¥å¿—
```

---

## ğŸ”§ è„šæœ¬å‘½ä»¤

### Celery ç®¡ç†è„šæœ¬

```bash
# å¯åŠ¨ Celery æœåŠ¡
./scripts/celery.sh start

# åœæ­¢ Celery æœåŠ¡
./scripts/celery.sh stop

# é‡å¯ Celery æœåŠ¡
./scripts/celery.sh restart

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./scripts/celery.sh status

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
./scripts/celery.sh logs

# å¯åŠ¨ Flower ç›‘æ§é¢æ¿
./scripts/celery.sh flower
```

### æœåŠ¡å¯åŠ¨è„šæœ¬

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåŒ…æ‹¬ Celeryï¼‰
./scripts/start.sh

# åå°å¯åŠ¨æ‰€æœ‰æœåŠ¡
./scripts/start.sh --bg

# åªå¯åŠ¨ Celery
./scripts/restart.sh --celery

# åœæ­¢æ‰€æœ‰æœåŠ¡
./scripts/stop.sh
```

---

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### 1. Flower ç›‘æ§é¢æ¿

è®¿é—® Flower æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼š
```
http://localhost:5555
```

åŠŸèƒ½ï¼š
- æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
- æŸ¥çœ‹ä»»åŠ¡å†å²è®°å½•
- ç›‘æ§ Worker çŠ¶æ€
- æŸ¥çœ‹ä»»åŠ¡ç»Ÿè®¡ä¿¡æ¯

### 2. æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
./scripts/celery.sh logs

# æˆ–æ‰‹åŠ¨æŸ¥çœ‹
tail -f logs/celery-beat.log
tail -f logs/celery-worker.log
```

### 3. æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹ Celery çŠ¶æ€
./scripts/celery.sh status

# æŸ¥çœ‹ Redis è¿æ¥
docker compose exec redis redis-cli ping
```

---

## ğŸ› ï¸ å·¥ä½œåŸç†

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡ç†åå° UI    â”‚
â”‚  /admin/workers â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EmailWorker    â”‚  â† Worker Manager é€‚é…å™¨
â”‚  (é€‚é…å™¨å±‚)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ scripts/        â”‚
â”‚ celery.sh       â”‚  â† Celery æœåŠ¡ç®¡ç†è„šæœ¬
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Celery æœåŠ¡                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Celery Beat  â”‚ Celery Workerâ”‚â”‚
â”‚  â”‚ (è°ƒåº¦å™¨)     â”‚ (æ‰§è¡Œå™¨)     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  app/tasks/     â”‚
â”‚  email.py       â”‚  â† é‚®ä»¶è½®è¯¢ä»»åŠ¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»»åŠ¡æµç¨‹

1. **Celery Beat** æ¯ 60 ç§’è§¦å‘ `poll_email_account` ä»»åŠ¡
2. **Celery Worker** æ¥æ”¶ä»»åŠ¡å¹¶æ‰§è¡Œï¼š
   - è¿æ¥ IMAP æœåŠ¡å™¨
   - æ‹‰å–æ–°é‚®ä»¶
   - å°†æ¯å°é‚®ä»¶åŠ å…¥å¤„ç†é˜Ÿåˆ—
3. **process_email** ä»»åŠ¡å¤„ç†å•å°é‚®ä»¶ï¼š
   - æŒä¹…åŒ–åˆ° OSS
   - è½¬æ¢ä¸º UnifiedEvent
   - åˆ†å‘åˆ° Dispatcher
   - å¯åŠ¨ Workflowï¼ˆå¦‚éœ€è¦ï¼‰

---

## âš™ï¸ é…ç½®è¯´æ˜

### é‚®ç®±è´¦æˆ·é…ç½®

åœ¨ç®¡ç†åå°æ·»åŠ é‚®ç®±è´¦æˆ·ï¼š
```
http://localhost:3000/admin/settings
```

å¿…éœ€å­—æ®µï¼š
- **IMAP Host**: IMAP æœåŠ¡å™¨åœ°å€ï¼ˆå¦‚ `imap.gmail.com`ï¼‰
- **IMAP Port**: IMAP ç«¯å£ï¼ˆé€šå¸¸ 993ï¼‰
- **IMAP User**: é‚®ç®±åœ°å€
- **IMAP Password**: é‚®ç®±å¯†ç æˆ–åº”ç”¨ä¸“ç”¨å¯†ç 
- **IMAP Use SSL**: æ˜¯å¦ä½¿ç”¨ SSLï¼ˆæ¨èå¼€å¯ï¼‰

### è½®è¯¢é—´éš”

é»˜è®¤ 60 ç§’ï¼Œå¯åœ¨ Worker é…ç½®ä¸­ä¿®æ”¹ï¼š
```json
{
  "poll_interval": 120  // æ”¹ä¸º 120 ç§’
}
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Celery æœåŠ¡æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**: `./scripts/celery.sh start` å¤±è´¥

**è§£å†³æ–¹æ³•**:
```bash
# 1. æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒ
ls -la backend/venv

# 2. æ£€æŸ¥ Redis
docker compose ps
docker compose exec redis redis-cli ping

# 3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯
cat logs/celery-beat.log
cat logs/celery-worker.log
```

### é—®é¢˜ 2: é‚®ä»¶ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œ

**ç—‡çŠ¶**: Flower ä¸­çœ‹ä¸åˆ°ä»»åŠ¡

**è§£å†³æ–¹æ³•**:
```bash
# 1. åŒæ­¥é‚®ä»¶ä»»åŠ¡
cd backend
source venv/bin/activate
python sync_email_tasks.py

# 2. æ£€æŸ¥é‚®ç®±è´¦æˆ·
# è®¿é—®ç®¡ç†åå°ï¼Œç¡®è®¤é‚®ç®±è´¦æˆ·å·²å¯ç”¨ä¸”é…ç½®æ­£ç¡®

# 3. é‡å¯ Celery
./scripts/celery.sh restart
```

### é—®é¢˜ 3: å‰ç«¯ Workers é¡µé¢æ— æ³•å¯åŠ¨é‚®ä»¶ Worker

**ç—‡çŠ¶**: ç‚¹å‡»å¯åŠ¨æŒ‰é’®å¤±è´¥

**å¯èƒ½åŸå› **:
1. Celery æœåŠ¡å¯åŠ¨è„šæœ¬ä¸å­˜åœ¨
2. æ²¡æœ‰æ‰§è¡Œæƒé™

**è§£å†³æ–¹æ³•**:
```bash
# 1. æ£€æŸ¥è„šæœ¬
ls -la scripts/celery.sh

# 2. æ·»åŠ æ‰§è¡Œæƒé™
chmod +x scripts/celery.sh

# 3. æ‰‹åŠ¨æµ‹è¯•
./scripts/celery.sh start
```

---

## ğŸ“ API ç«¯ç‚¹

### åŒæ­¥é‚®ä»¶ä»»åŠ¡

```bash
POST /admin/workers/sync-email-tasks
Authorization: Bearer <token>
```

å“åº”ï¼š
```json
{
  "success": true,
  "message": "é‚®ä»¶ä»»åŠ¡åŒæ­¥å®Œæˆ",
  "stats": {
    "added": 2,
    "removed": 0,
    "updated": 0,
    "total": 2
  }
}
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

- âœ… ä½¿ç”¨ Supervisor æˆ– systemd ç®¡ç† Celery è¿›ç¨‹
- âœ… å¯ç”¨ Celery Worker è‡ªåŠ¨é‡å¯ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
- âœ… é…ç½®æ—¥å¿—è½®è½¬ï¼ˆé¿å…æ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼‰
- âœ… ä½¿ç”¨ Redis Sentinel æˆ– Clusterï¼ˆé«˜å¯ç”¨ï¼‰

### 2. æ€§èƒ½ä¼˜åŒ–

- âœ… è°ƒæ•´ Worker å¹¶å‘æ•°ï¼ˆæ ¹æ® CPU æ ¸å¿ƒæ•°ï¼‰
- âœ… ä½¿ç”¨ä»»åŠ¡ä¼˜å…ˆçº§ï¼ˆé‡è¦é‚®ä»¶ä¼˜å…ˆå¤„ç†ï¼‰
- âœ… é…ç½®ä»»åŠ¡è¶…æ—¶ï¼ˆé˜²æ­¢å¡æ­»ï¼‰
- âœ… å¯ç”¨ä»»åŠ¡ç»“æœè¿‡æœŸï¼ˆé¿å… Redis å†…å­˜æº¢å‡ºï¼‰

### 3. ç›‘æ§å‘Šè­¦

- âœ… ç›‘æ§ Celery Beat å¿ƒè·³
- âœ… ç›‘æ§ Worker é˜Ÿåˆ—é•¿åº¦
- âœ… ç›‘æ§ä»»åŠ¡å¤±è´¥ç‡
- âœ… ç›‘æ§ Redis å†…å­˜ä½¿ç”¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Celery å®˜æ–¹æ–‡æ¡£](https://docs.celeryq.dev/)
- [Flower æ–‡æ¡£](https://flower.readthedocs.io/)
- [Redis æ–‡æ¡£](https://redis.io/documentation)
- [APScheduler è¿ç§»åˆ° Celery æŒ‡å—](https://medium.com/@migrating-from-apscheduler)

---

## ğŸ”„ è¿ç§»æ£€æŸ¥æ¸…å•

å®Œæˆä»¥ä¸‹æ­¥éª¤ç¡®ä¿è¿ç§»æˆåŠŸï¼š

- [ ] Celery æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] Flower ç›‘æ§é¢æ¿å¯è®¿é—®
- [ ] é‚®ä»¶ä»»åŠ¡å·²åŒæ­¥
- [ ] å‰ç«¯ Workers é¡µé¢æ˜¾ç¤ºé‚®ä»¶ Worker
- [ ] å¯é€šè¿‡å‰ç«¯å¯åŠ¨/åœæ­¢é‚®ä»¶ Worker
- [ ] é‚®ä»¶è½®è¯¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] æ—¥å¿—è¾“å‡ºæ­£å¸¸
- [ ] æ¸…ç†æ—§çš„ APScheduler ç›¸å…³ä»£ç ï¼ˆå¦‚æœ‰ï¼‰

---

**æœ€åæ›´æ–°**: 2026-02-01
**ç»´æŠ¤è€…**: Concord AI Team
