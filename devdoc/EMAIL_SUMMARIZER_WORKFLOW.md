# EmailSummarizerAgent 工作流程图

> 最后更新: 2026-02-07

---

## 1. 触发方式

EmailSummarizerAgent 有 **3 种触发方式**：

```
┌──────────────────────────────────────────────────────────────────┐
│                      触发入口                                     │
│                                                                  │
│  ① Celery 定时任务              ② API 手动触发                    │
│     poll_email_account             POST /emails/{id}/ai-analyze  │
│     ↓                              ↓                             │
│     process_email                  ai_analyze_email()            │
│     ↓                              ↓                             │
│  EventDispatcher.dispatch()     email_summarizer.analyze()       │
│     ↓                                                            │
│  _classify_intent()            ③ 并行分类（暂未启用）               │
│     ↓                              _classify_parallel()          │
│  agent_registry.run(               ↓                             │
│    "email_summarizer")          asyncio.gather(                  │
│                                    email_summarizer,             │
│                                    work_type_analyzer            │
│                                 )                                │
└──────────────────────────────────────────────────────────────────┘
```

**关键文件**：
- `app/api/emails.py:648` — API 手动触发入口
- `app/messaging/dispatcher.py:237` — EventDispatcher 自动触发
- `app/messaging/dispatcher.py:159` — 并行分类（EmailSummarizer + WorkTypeAnalyzer）

---

## 2. 完整工作流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    EmailSummarizerAgent.analyze()                        │
│                    入口: email_summarizer.py:44                          │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  输入参数                                                                │
│  ┌────────────────────────────────────────────────────────────────┐     │
│  │  email_id     : str          — 邮件 ID                         │     │
│  │  sender       : str          — 发件人邮箱                       │     │
│  │  sender_name  : Optional[str]— 发件人名称                       │     │
│  │  subject      : str          — 邮件主题                         │     │
│  │  body_text    : str          — 纯文本正文                       │     │
│  │  body_html    : Optional[str]— HTML 正文                        │     │
│  │  received_at  : Optional[dt] — 收件时间                         │     │
│  └────────────────────────────────────────────────────────────────┘     │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Step 1: 邮件正文清洗                                                    │
│  clean_email_content()  — email_cleaner.py:332                          │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │   body_text / body_html                                           │  │
│  │        │                                                          │  │
│  │        ▼                                                          │  │
│  │   ┌─────────────────┐     参数配置:                                │  │
│  │   │ 优先使用纯文本    │     • max_length = 10000 字符              │  │
│  │   │ HTML 作为备选     │     • remove_signature = False (保留签名)  │  │
│  │   └────────┬────────┘     • remove_quotes = False (保留引用历史)   │  │
│  │            │                                                      │  │
│  │            ▼                                                      │  │
│  │   ┌──────────────────────────────────────────────┐                │  │
│  │   │  处理管道:                                     │                │  │
│  │   │                                               │                │  │
│  │   │  1. HTML → 纯文本 (如果使用 HTML)              │                │  │
│  │   │     ├─ 移除 <style>, <script>, <head>         │                │  │
│  │   │     ├─ 清除所有 HTML 标签                      │                │  │
│  │   │     └─ 解码 HTML 实体 (&nbsp; &lt; 等)         │                │  │
│  │   │                                               │                │  │
│  │   │  2. 签名移除 (当前关闭)                        │                │  │
│  │   │     ├─ 检测 "Best regards" / "此致" 等         │                │  │
│  │   │     └─ 检测 "Sent from my iPhone" 等          │                │  │
│  │   │                                               │                │  │
│  │   │  3. 引用移除 (当前关闭)                        │                │  │
│  │   │     ├─ 检测 "On ... wrote:" 等                │                │  │
│  │   │     └─ 检测 ">" 引用行                        │                │  │
│  │   │                                               │                │  │
│  │   │  4. 规范化空白                                 │                │  │
│  │   │     ├─ 多个空行 → 单个空行                     │                │  │
│  │   │     └─ 移除行尾空白                            │                │  │
│  │   │                                               │                │  │
│  │   │  5. 截断 (>10000 字符时)                       │                │  │
│  │   │     ├─ 优先在句号处截断                         │                │  │
│  │   │     └─ 其次在换行处截断                         │                │  │
│  │   └───────────────────────────────────────────────┘                │  │
│  │            │                                                      │  │
│  │            ▼                                                      │  │
│  │     cleaned_content (清洗后的文本)                                 │  │
│  │                                                                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ❌ 如果 cleaned_content 为空 → 返回 _empty_result("邮件正文为空")       │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ ✅ 正文不为空
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Step 2: 加载 System Prompt                                             │
│  get_prompt("email_summarizer_system")  — prompts/manager.py            │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │   加载优先级:                                                      │  │
│  │                                                                   │  │
│  │   ① 数据库 (system_prompts 表)                                    │  │
│  │      ↓ 未找到                                                     │  │
│  │   ② defaults.py 内置模板                                          │  │
│  │      ↓ 未找到                                                     │  │
│  │   ③ 硬编码回退:                                                    │  │
│  │      "You are a professional foreign trade                        │  │
│  │       email analysis assistant..."                                │  │
│  │                                                                   │  │
│  │   System Prompt 内容 (defaults.py):                               │  │
│  │   ┌─────────────────────────────────────────────────────────┐     │  │
│  │   │  角色: 外贸邮件分析助手                                    │     │  │
│  │   │  输出: 严格 JSON 格式                                     │     │  │
│  │   │  要求: 填充所有字段，无法识别用 null 或 []                  │     │  │
│  │   └─────────────────────────────────────────────────────────┘     │  │
│  │                                                                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Step 3: 构建 User Prompt (变量渲染)                                    │
│  render_prompt("email_summarizer", **vars)  — prompts/manager.py        │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │   模板变量:                                                        │  │
│  │   ┌─────────────────────────────────────────────────────────┐     │  │
│  │   │  {{sender}}       ← sender (发件人邮箱)                  │     │  │
│  │   │  {{sender_name}}  ← sender_name (发件人名称)             │     │  │
│  │   │  {{subject}}      ← subject (邮件主题)                   │     │  │
│  │   │  {{received_at}}  ← received_at (收件时间, 格式化)       │     │  │
│  │   │  {{content}}      ← cleaned_content (清洗后正文)         │     │  │
│  │   └─────────────────────────────────────────────────────────┘     │  │
│  │                                                                   │  │
│  │   渲染后输出: 包含邮件元信息 + 正文的完整分析请求                    │  │
│  │                                                                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ❌ 如果 prompt 为空 → 返回 _empty_result("Prompt loading failed")      │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ ✅ prompt 加载成功
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Step 4: 调用 LLM                                                       │
│  self.llm.chat()  — llm/gateway.py                                      │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │   ┌──────────────────────┐                                        │  │
│  │   │    LLMGateway.chat() │                                        │  │
│  │   └──────────┬───────────┘                                        │  │
│  │              │                                                    │  │
│  │              ▼                                                    │  │
│  │   ┌──────────────────────┐                                        │  │
│  │   │  模型选择优先级:       │                                        │  │
│  │   │  ① Agent.model 属性   │                                        │  │
│  │   │  ② 环境变量            │                                        │  │
│  │   │    DEFAULT_LLM_MODEL  │                                        │  │
│  │   │  ③ config.py 默认值   │                                        │  │
│  │   └──────────┬───────────┘                                        │  │
│  │              │                                                    │  │
│  │              ▼                                                    │  │
│  │   ┌──────────────────────┐        ┌───────────────────────┐       │  │
│  │   │      LiteLLM         │───────▶│  LLM Provider API     │       │  │
│  │   │  (统一多模型网关)      │◀───────│  Claude/GPT/Gemini... │       │  │
│  │   └──────────┬───────────┘        └───────────────────────┘       │  │
│  │              │                                                    │  │
│  │              ▼                                                    │  │
│  │   ┌──────────────────────┐                                        │  │
│  │   │    LLMResponse       │                                        │  │
│  │   │  • content (文本)     │                                        │  │
│  │   │  • model (模型名)     │                                        │  │
│  │   │  • usage (token 统计) │                                        │  │
│  │   │  • finish_reason     │                                        │  │
│  │   └──────────────────────┘                                        │  │
│  │                                                                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  ❌ 如果调用异常 → 返回 _empty_result(error_message)                     │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ ✅ LLM 返回成功
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Step 5: 解析 LLM 返回                                                  │
│  _parse_response(content)  — email_summarizer.py:134                    │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │   LLM 原始返回文本                                                 │  │
│  │        │                                                          │  │
│  │        ▼                                                          │  │
│  │   尝试 1: json.loads(content)                                     │  │
│  │        │                                                          │  │
│  │        ├── ✅ 成功 → 返回 dict                                    │  │
│  │        │                                                          │  │
│  │        ▼ ❌ JSONDecodeError                                       │  │
│  │   尝试 2: 从 ```json ... ``` 代码块提取                            │  │
│  │        │   正则: ```(?:json)?\s*(\{.*?\})\s*```                   │  │
│  │        │                                                          │  │
│  │        ├── ✅ 成功 → 返回 dict                                    │  │
│  │        │                                                          │  │
│  │        ▼ ❌ 未匹配或解析失败                                       │  │
│  │   尝试 3: 查找第一个 { 到最后一个 }                                 │  │
│  │        │   content[start:end]                                     │  │
│  │        │                                                          │  │
│  │        ├── ✅ 成功 → 返回 dict                                    │  │
│  │        │                                                          │  │
│  │        ▼ ❌ 仍然失败                                              │  │
│  │   返回 {"parse_error": True, "raw_response": content[:500]}       │  │
│  │                                                                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  Step 6: 组装返回结果                                                    │
│  email_summarizer.py:122-128                                            │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                                                                   │  │
│  │   解析后的 result dict                                             │  │
│  │        │                                                          │  │
│  │        ▼  追加元数据:                                              │  │
│  │   ┌───────────────────────────────────────────────────────┐       │  │
│  │   │  result["email_id"]        = email_id                 │       │  │
│  │   │  result["cleaned_content"] = cleaned_content          │       │  │
│  │   │  result["llm_model"]       = model                    │       │  │
│  │   │  result["token_used"]      = response.usage.total     │       │  │
│  │   └───────────────────────────────────────────────────────┘       │  │
│  │                                                                   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  输出结果 (写入 email_analyses 表)                                       │
│                                                                         │
│  ┌─── 摘要与翻译 ───┐  ┌─── 发件方信息 ───┐  ┌─── 意图分类 ─────────┐  │
│  │ summary          │  │ sender_type      │  │ intent              │  │
│  │ key_points[]     │  │ sender_company   │  │ intent_confidence   │  │
│  │ original_language│  │ sender_country   │  │ urgency             │  │
│  └──────────────────┘  │ is_new_contact   │  │ sentiment           │  │
│                        └──────────────────┘  └─────────────────────┘  │
│                                                                         │
│  ┌─── 业务信息 ──────────────────┐  ┌─── 跟进建议 ──────────────────┐  │
│  │ products[{name,specs,qty,    │  │ questions[]                    │  │
│  │   unit,target_price}]        │  │ action_required[]              │  │
│  │ amounts[{value,currency,     │  │ suggested_reply                │  │
│  │   context}]                  │  │ priority (p0/p1/p2/p3)         │  │
│  │ trade_terms{incoterm,        │  └────────────────────────────────┘  │
│  │   payment_terms,destination} │                                      │
│  │ deadline                     │  ┌─── 分析元数据 ──────────────────┐  │
│  └──────────────────────────────┘  │ cleaned_content                │  │
│                                     │ llm_model                      │  │
│                                     │ token_used                     │  │
│                                     └────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 简化流程图

```
  邮件原始数据
       │
       ▼
  ┌─────────────┐
  │ 1. 正文清洗   │  clean_email_content()
  │  HTML→文本    │  保留签名和引用历史
  │  规范化空白    │  截断到 10000 字符
  └──────┬──────┘
         │
         ▼ 正文为空? ──── Yes ──▶ 返回空结果
         │ No
         ▼
  ┌─────────────┐
  │ 2. 加载Prompt│  DB → defaults.py → 硬编码回退
  │  System      │  email_summarizer_system
  │  User        │  email_summarizer + 变量渲染
  └──────┬──────┘
         │
         ▼ Prompt 为空? ── Yes ──▶ 返回空结果
         │ No
         ▼
  ┌─────────────┐
  │ 3. 调用 LLM  │  LiteLLM → Claude/GPT/Gemini...
  │  chat()      │  非工具调用模式
  └──────┬──────┘
         │
         ▼ 异常? ────── Yes ──▶ 返回空结果
         │ No
         ▼
  ┌─────────────┐
  │ 4. 解析 JSON │  3 级回退策略:
  │              │  直接解析 → 代码块提取 → 花括号匹配
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │ 5. 追加元数据 │  email_id, cleaned_content,
  │              │  llm_model, token_used
  └──────┬──────┘
         │
         ▼
  ┌─────────────┐
  │ 6. 持久化     │  写入 email_analyses 表
  │  返回结果     │  (由调用方负责)
  └─────────────┘
```

---

## 4. 错误处理流程

```
  任意步骤失败
       │
       ▼
  _empty_result(email_id, error)
       │
       ▼
  ┌──────────────────────────────────┐
  │  {                               │
  │    "email_id": email_id,         │
  │    "summary": "分析失败: {error}",│
  │    "key_points": [],             │
  │    "intent": "other",            │
  │    "intent_confidence": 0,       │
  │    "urgency": "low",             │
  │    "sentiment": "neutral",       │
  │    "priority": "p3",             │
  │    "error": error                │
  │  }                               │
  └──────────────────────────────────┘
```

---

## 5. 与其他组件的交互关系

```
                          ┌──────────────────┐
                          │   Celery Worker   │
                          │ (email 队列)       │
                          └────────┬─────────┘
                                   │ poll → dispatch
                                   ▼
┌──────────┐           ┌──────────────────────┐           ┌──────────┐
│ API 端点  │──────────▶│  EmailSummarizer     │──────────▶│ 数据库    │
│ /emails/ │           │  Agent               │           │ email_   │
│ {id}/    │           │                      │           │ analyses │
│ ai-      │           │  ┌────────────────┐  │           └──────────┘
│ analyze  │           │  │ EmailCleaner   │  │
└──────────┘           │  │ Tool           │  │
                       │  └────────────────┘  │
                       │                      │
                       │  ┌────────────────┐  │           ┌──────────┐
                       │  │ PromptManager  │◀─┼───────────│ system_  │
                       │  │ (缓存 5 分钟)   │  │           │ prompts  │
                       │  └────────────────┘  │           │ 表       │
                       │                      │           └──────────┘
                       │  ┌────────────────┐  │
                       │  │ LLMGateway     │  │           ┌──────────┐
                       │  │ (LiteLLM)      │──┼──────────▶│ LLM API  │
                       │  └────────────────┘  │           │ Provider │
                       └──────────────────────┘           └──────────┘
```

---

## 6. 关键代码位置

| 步骤 | 方法 | 文件:行号 |
|------|------|----------|
| 入口 | `analyze()` | `app/agents/email_summarizer.py:44` |
| 正文清洗 | `clean_email_content()` | `app/tools/email_cleaner.py:332` |
| HTML 清洗 | `clean_html()` | `app/tools/email_cleaner.py:73` |
| 签名移除 | `remove_signature()` | `app/tools/email_cleaner.py:98` |
| 引用移除 | `remove_quoted_content()` | `app/tools/email_cleaner.py:129` |
| 内容截断 | `truncate_content()` | `app/tools/email_cleaner.py:195` |
| 加载 Prompt | `get_prompt()` | `app/llm/prompts/manager.py` |
| 渲染 Prompt | `render_prompt()` | `app/llm/prompts/manager.py` |
| 默认 Prompt | `DEFAULT_PROMPTS["email_summarizer"]` | `app/llm/prompts/defaults.py:74` |
| LLM 调用 | `llm.chat()` | `app/llm/gateway.py` |
| 模型选择 | `_get_model()` | `app/agents/base.py:100` |
| JSON 解析 | `_parse_response()` | `app/agents/email_summarizer.py:134` |
| 空结果 | `_empty_result()` | `app/agents/email_summarizer.py:172` |
| 兼容接口 | `run()` | `app/agents/email_summarizer.py:190` |
| API 触发 | `ai_analyze_email()` | `app/api/emails.py:648` |
| 自动触发 | `_classify_intent()` | `app/messaging/dispatcher.py:237` |
| 结果存储 | `EmailAnalysis` 模型 | `app/models/email_analysis.py:20` |
