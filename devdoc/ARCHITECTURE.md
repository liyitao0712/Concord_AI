# Concord AI 系统架构

> 最后更新：2026-01-31

## 系统概览

Concord AI 是一个企业级 AI 中台系统，用于自动化处理邮件、即时消息等业务通信。

**核心理念：先看懂，再处理**

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              外部数据源                                       │
├──────────────────┬──────────────────┬──────────────────┬───────────────────┤
│   IMAP 邮箱       │   飞书 WebSocket  │   Web Chat       │   Webhook        │
│  (Email Worker)  │  (Feishu Worker) │   (API)          │   (API)          │
└────────┬─────────┴────────┬─────────┴────────┬─────────┴─────────┬────────┘
         │                  │                  │                   │
         ▼                  ▼                  ▼                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Adapter 层（适配器）                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                      │
│  │ EmailAdapter │  │FeishuAdapter │  │ ChatAdapter  │  → UnifiedEvent      │
│  └──────────────┘  └──────────────┘  └──────────────┘                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       ① AI 分析层（Analysis Layer）                          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  • 输入：UnifiedEvent（邮件/消息原文）                                  │  │
│  │  • 处理：调用 LLM 进行完整分析                                         │  │
│  │  • 输出：结构化分析结果（AnalysisResult）                              │  │
│  │  • 存储：保存到 event_analysis 表                                      │  │
│  │                                                                       │  │
│  │  ⚙️ 可配置：分析字段、分析 Prompt                                      │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       ② 规则引擎层（Rule Engine）                            │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  • 输入：分析结果 + AI 建议的动作                                      │  │
│  │  • 处理：匹配规则，决定触发哪些工作流                                   │  │
│  │  • 输出：待执行的工作流列表                                            │  │
│  │                                                                       │  │
│  │  ⚙️ 可配置：路由规则（条件 → 动作）                                    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       ③ 执行层（Temporal Workflows）                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ 通知 Worker │  │ 报价 Worker │  │ 订单 Worker │  │ 人工队列    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                                             │
│  ⚙️ 可配置：各 Workflow 的 Agent Prompt、工具集                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据存储层                                       │
├──────────────────┬──────────────────┬──────────────────┬───────────────────┤
│   PostgreSQL     │      Redis       │    阿里云 OSS     │   Temporal        │
│   (业务数据)      │   (缓存/队列)     │   (文件存储)      │   (工作流状态)     │
└──────────────────┴──────────────────┴──────────────────┴───────────────────┘
```

---

## 可配置项总览

系统支持用户自定义的配置项：

| 配置类型 | 存储位置 | 说明 |
|---------|---------|------|
| **分析字段** | `analysis_fields` 表 | 定义分析结果包含哪些字段 |
| **分析 Prompt** | `prompts` 表 | 分析 Agent 的系统提示词 |
| **路由规则** | `routing_rules` 表 | 条件 → 触发工作流的映射 |
| **Agent Prompt** | `prompts` 表 | 各业务 Agent 的提示词 |
| **LLM 配置** | `system_settings` 表 | 模型选择、API Key |
| **Worker 配置** | `worker_configs` 表 | 各 Worker 的参数 |

详见 [业务流程文档](./BUSINESS_FLOWS.md) 中的配置说明。

---

## 核心模块

### 1. Worker（后台工作进程）

独立运行的 Python 进程，负责数据采集。

| Worker | 文件 | 功能 | 运行方式 |
|--------|------|------|----------|
| Email Worker | `workers/email_worker.py` | IMAP 邮件拉取 | `python -m app.workers.email_worker` |
| Feishu Worker | `workers/feishu_worker.py` | 飞书 WebSocket 长连接 | `python -m app.workers.feishu_worker` |
| Temporal Worker | `workflows/worker.py` | Workflow/Activity 执行 | `python -m app.workflows.worker` |

```
┌─────────────────────────────────────────────────────────────────┐
│                      Worker 进程架构                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                                           │
│  │  Email Worker   │ ──► APScheduler 定时拉取 (60s)             │
│  │                 │     └─► IMAP Fetch                        │
│  │                 │         └─► Persist to DB/OSS             │
│  │                 │             └─► Dispatch Event            │
│  └─────────────────┘                                           │
│                                                                 │
│  ┌─────────────────┐                                           │
│  │  Feishu Worker  │ ──► WebSocket 长连接                       │
│  │  (in API proc)  │     └─► 消息去重 (Redis)                   │
│  │                 │         └─► LLM 回复                       │
│  │                 │             └─► 发送回复                   │
│  └─────────────────┘                                           │
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ Temporal Worker │ ──► 监听任务队列                           │
│  │                 │     └─► 执行 Workflow                      │
│  │                 │         └─► 执行 Activity                  │
│  └─────────────────┘                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. Adapter（适配器）

将不同来源的消息转换为统一的 `UnifiedEvent` 格式。

```python
# UnifiedEvent 核心字段
class UnifiedEvent:
    event_id: str           # 唯一标识
    event_type: str         # email / chat / webhook
    source: str             # email / feishu / web
    content: str            # 消息内容
    user_external_id: str   # 发送者标识（邮箱/open_id）
    metadata: dict          # 额外信息（主题、附件等）
    idempotency_key: str    # 幂等键
```

### 3. Agent（AI 智能体）

基于 LangGraph 的 AI 处理单元。

| Agent | 功能 | 工具 |
|-------|------|------|
| `intent_classifier` | 意图分类 | 无（纯 LLM） |
| `email_analyzer` | 邮件分析 | 无 |
| `quote_agent` | 报价生成 | `search_products`, `calculate_price` |
| `chat_agent` | 对话助手 | 可配置 |

```
┌─────────────────────────────────────────────────────────────────┐
│                      Agent 执行流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Input ──► System Prompt ──► LLM ──► Tool Calls? ──► Output   │
│                                │           │                    │
│                                │      ┌────┴────┐               │
│                                │      ▼         │               │
│                                │   Execute    Loop               │
│                                │    Tools       │               │
│                                │      │         │               │
│                                │      └─────────┘               │
│                                │                                │
│                                ▼                                │
│                           AgentResult                           │
│                         {success, output, data}                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4. Workflow（工作流）

基于 Temporal 的持久化工作流。

```
┌─────────────────────────────────────────────────────────────────┐
│                  EmailProcessWorkflow                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────┐    ┌─────────────┐    ┌─────────────────────┐    │
│   │ Started │───►│ Route by    │───►│ Handle Intent       │    │
│   │         │    │ Intent      │    │                     │    │
│   └─────────┘    └─────────────┘    │ inquiry → Quote     │    │
│                                     │ complaint → Notify  │    │
│                                     │ other → Manual      │    │
│                                     └──────────┬──────────┘    │
│                                                │               │
│                                                ▼               │
│                                     ┌─────────────────────┐    │
│                                     │ Update Event Status │    │
│                                     └──────────┬──────────┘    │
│                                                │               │
│                                                ▼               │
│                                     ┌─────────────────────┐    │
│                                     │     Completed       │    │
│                                     └─────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

⚠️ 安全说明：自动回复功能已禁用，报价仅生成草稿待人工审核
```

---

## 数据流

### 邮件处理流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  IMAP    │────►│  Email   │────►│  Event   │────►│ Temporal │
│  Server  │     │  Worker  │     │Dispatcher│     │ Workflow │
└──────────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
                      │                │                │
                      ▼                ▼                ▼
               ┌──────────┐     ┌──────────┐     ┌──────────┐
               │email_raw │     │  events  │     │ workflow │
               │_messages │     │   表     │     │ _exec    │
               └──────────┘     └──────────┘     └──────────┘
```

### 飞书消息处理流程

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  飞书     │────►│ WebSocket│────►│  Redis   │────►│   LLM    │
│  Server  │     │  Client  │     │  去重    │     │  生成    │
└──────────┘     └──────────┘     └──────────┘     └────┬─────┘
                                                        │
                                                        ▼
                                                 ┌──────────┐
                                                 │ 发送回复  │
                                                 │ (飞书API) │
                                                 └──────────┘
```

---

## 数据模型

### 核心表结构

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据库表关系                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  users ◄───────────────────┐                                   │
│    │                       │                                   │
│    │                       │                                   │
│    ▼                       │                                   │
│  chat_sessions ──────► chat_messages                           │
│                                                                 │
│  email_accounts ──────► email_raw_messages ──────► attachments │
│                                                                 │
│  events ◄─────────────────── workflow_executions               │
│    │                              │                            │
│    │                              ▼                            │
│    │                       agent_executions                    │
│    │                                                           │
│    ▼                                                           │
│  (intent, status, response_content)                            │
│                                                                 │
│  system_settings (LLM 配置、系统参数)                           │
│  worker_configs (Worker 配置)                                   │
│  prompts (可配置的系统提示词)                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 关键字段说明

| 表 | 关键字段 | 说明 |
|---|---------|------|
| `events` | `intent` | 意图分类结果 |
| `events` | `status` | pending/processing/completed/failed |
| `events` | `workflow_id` | 关联的 Temporal Workflow |
| `events` | `response_content` | AI 生成的响应（待审核） |
| `email_raw_messages` | `oss_key` | 原始邮件 OSS 路径 |
| `email_raw_messages` | `is_processed` | 是否已处理 |

---

## API 结构

```
/api
├── /auth                    # 认证
│   ├── POST /login          # 登录
│   └── POST /logout         # 登出
│
├── /chat                    # 对话
│   ├── POST /sessions       # 创建会话
│   ├── GET  /sessions       # 会话列表
│   └── POST /sessions/{id}/messages  # 发送消息 (SSE)
│
├── /admin                   # 管理后台
│   ├── /users               # 用户管理
│   ├── /llm                 # LLM 配置
│   ├── /settings            # 系统设置
│   ├── /workers             # Worker 管理
│   ├── /email-accounts      # 邮箱账户
│   └── /monitor             # 运行监控
│       ├── GET /summary     # 监控摘要
│       ├── GET /workflows   # 工作流列表
│       └── GET /agents      # Agent 统计
│
├── /workflows               # 工作流 API
│   ├── POST /{id}/approve   # 审批通过
│   └── POST /{id}/reject    # 审批拒绝
│
└── /health                  # 健康检查
```

---

## 部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        Docker Compose                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   Nginx     │  │   FastAPI   │  │   Next.js   │             │
│  │   (代理)    │  │   (后端)    │  │   (前端)    │             │
│  │   :80/443   │  │   :8000     │  │   :3000     │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ PostgreSQL  │  │   Redis     │  │  Temporal   │             │
│  │   :5432     │  │   :6379     │  │   :7233     │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
│                                                                 │
│  ┌─────────────────────────────────────────────────┐           │
│  │              Worker 进程 (独立运行)              │           │
│  │  • Email Worker                                 │           │
│  │  • Temporal Worker                              │           │
│  └─────────────────────────────────────────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

外部服务：
• 阿里云 OSS（文件存储）
• LLM API（Anthropic / OpenAI）
• IMAP/SMTP（邮件服务）
• 飞书开放平台
```

---

## 配置管理

### 环境变量 (.env)

```bash
# 数据库
DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/concord

# Redis
REDIS_URL=redis://localhost:6379/0

# Temporal
TEMPORAL_HOST=localhost:7233
TEMPORAL_NAMESPACE=default
TEMPORAL_TASK_QUEUE=concord-main-queue

# OSS (可选)
OSS_ACCESS_KEY_ID=xxx
OSS_ACCESS_KEY_SECRET=xxx
OSS_BUCKET_NAME=xxx
OSS_ENDPOINT=xxx

# JWT
JWT_SECRET_KEY=xxx
```

### 数据库配置 (system_settings)

| Key | 说明 |
|-----|------|
| `llm.default_model` | 默认 LLM 模型 |
| `llm.anthropic_api_key` | Anthropic API Key |
| `llm.openai_api_key` | OpenAI API Key |

### Worker 配置 (worker_configs)

| 字段 | 说明 |
|-----|------|
| `worker_type` | email / feishu / temporal |
| `config` | JSON 配置 |
| `is_active` | 是否启用 |

---

## 安全注意事项

1. **自动回复已禁用** - 所有 AI 生成的回复需人工审核
2. **Redis 消息去重** - 防止重复处理
3. **幂等性检查** - Event 表 `idempotency_key` 唯一索引
4. **API 认证** - JWT Token + 管理员权限校验
5. **敏感信息** - API Key 存储在数据库，不在代码中

---

## 待完善功能

| 模块 | 功能 | 状态 |
|------|------|------|
| Workflow | 订单处理 (`_handle_order`) | 待实现 |
| Workflow | 跟进处理 (`_handle_follow_up`) | 待实现 |
| Notification | 邮件/短信通知发送 | 待实现 |
| Admin | 事件列表页面 | 待实现 |
| Admin | 审批管理页面 | 待实现 |
| Admin | 系统日志页面 | 待实现 |
| Chat | Chatbox SSE 流式对话 | 待实现 |
